// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// Enums
// ========================================

enum Role {
  USER
  ADMIN
  RESEARCHER
}

enum ConsentStatus {
  PENDING
  APPROVED
  DENIED
  REVOKED
}

// ========================================
// NextAuth 모델
// ========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - NextAuth
  accounts Account[]
  sessions Session[]

  // Relations - App
  userData      UserData?
  quests        Quest[]
  lessonSessions LessonSession[]
  checkins      Checkin[]
  badges        UserBadge[]
  statSnapshots StatSnapshot[]
  answers       Answer[]
  rewardEvents  RewardEvent[]
  reportEntries ReportEntry[]

  // Relations - B2B
  executionMetrics ExecutionMetric[]
  dataConsents     DataConsent[]
  receivedMessages DirectMessage[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ========================================
// 사용자 데이터 (localStorage 대체 - 핵심)
// ========================================

model UserData {
  id     String @id @default(cuid())
  userId String @unique

  energy          Int     @default(50)
  levelData       Json    @default("{\"level\":1,\"progress\":{\"cognition\":0,\"selfDirected\":0,\"habit\":0,\"attitude\":0,\"relationship\":0,\"character\":0}}")
  executions      Json    @default("[]")
  history         Json    @default("[]")
  bucketList      Json    @default("[]")
  monthlyGoals    Json    @default("{}")
  surveyMilestones Json    @default("[]")

  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// 월드 시스템
// ========================================

model World {
  id          String @id @default(cuid())
  key         String @unique
  title       String
  subtitle    String
  description String
  colorHex    String
  icon        String
  order       Int

  coach         Coach?
  lessonNodes   LessonNode[]
  questions     Question[]
  sessions      LessonSession[]
  statSnapshots StatSnapshot[]
  reportEntries ReportEntry[]
}

model Coach {
  id         String @id @default(cuid())
  worldId    String @unique
  name       String
  tagline    String
  avatarSeed String

  world     World           @relation(fields: [worldId], references: [id], onDelete: Cascade)
  questions Question[]
  sessions  LessonSession[]
}

model LessonNode {
  id       String  @id @default(cuid())
  worldId  String
  order    Int
  title    String
  subtitle String?
  isLocked Boolean @default(true)
  xpReward Int     @default(20)

  world    World           @relation(fields: [worldId], references: [id], onDelete: Cascade)
  sessions LessonSession[]

  @@unique([worldId, order])
}

model Question {
  id          String  @id @default(cuid())
  worldId     String
  coachId     String
  prompt      String
  type        String  @default("text")
  optionsJson String?
  order       Int

  world   World    @relation(fields: [worldId], references: [id], onDelete: Cascade)
  coach   Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  answers Answer[]
}

// ========================================
// 레슨 세션 & 답변
// ========================================

model LessonSession {
  id           String    @id @default(cuid())
  userId       String
  worldId      String
  coachId      String
  lessonNodeId String

  status     String    @default("in_progress")
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  xpEarned   Int       @default(0)

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  world      World      @relation(fields: [worldId], references: [id])
  coach      Coach      @relation(fields: [coachId], references: [id])
  lessonNode LessonNode @relation(fields: [lessonNodeId], references: [id])
  answers    Answer[]
  report     ReportEntry?
}

model Answer {
  id         String   @id @default(cuid())
  sessionId  String
  questionId String
  userId     String
  rawText    String
  createdAt  DateTime @default(now())

  session  LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question Question      @relation(fields: [questionId], references: [id])
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// 보상 & 리포트
// ========================================

model RewardEvent {
  id        String   @id @default(cuid())
  userId    String
  type      String
  value     Int      @default(0)
  metaJson  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReportEntry {
  id        String @id @default(cuid())
  userId    String
  worldKey  String
  sessionId String @unique
  worldId   String

  title    String
  summary  String
  evidence String?
  keywords String?

  createdAt DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  session LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  world   World         @relation(fields: [worldId], references: [id])
}

// ========================================
// 성장 지표
// ========================================

model StatSnapshot {
  id       String  @id @default(cuid())
  userId   String
  worldId  String?
  worldKey String

  level0to4       Float   @default(0)
  confidence0to1  Float   @default(0)
  evidenceSnippet String?

  updatedAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  world World? @relation(fields: [worldId], references: [id])

  @@unique([userId, worldKey])
}

// ========================================
// 기존 모델 (하위 호환)
// ========================================

model Quest {
  id          String    @id @default(cuid())
  userId      String
  title       String
  description String?
  category    String
  xpReward    Int       @default(10)
  status      String    @default("pending")
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Checkin {
  id        String   @id @default(cuid())
  userId    String
  mood      Int      @default(3)
  energy    Int      @default(3)
  note      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Badge {
  id          String @id @default(cuid())
  name        String @unique
  description String
  iconUrl     String?
  category    String
  requirement String

  users UserBadge[]
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

// ========================================
// 설문조사 응답
// ========================================

model SurveyResponse {
  id              String @id @default(cuid())
  userHash        String
  milestone       Int    @default(5)
  encryptedData   String
  careerScore     Float
  communityScore  Float
  nonCognitiveScore Float
  totalScore      Float

  createdAt DateTime @default(now())

  @@index([milestone])
}

// ========================================
// B2B 실행 DNA 대시보드
// ========================================

model ExecutionMetric {
  id     String @id @default(cuid())
  userId String
  period String // "2026-01", "2026-Q1" 등

  // ISO 30414 기반 8개 실행 역량 지표 (0~100)
  initiative      Float @default(0) // 자기주도 실행력
  consistency     Float @default(0) // 실행 일관성
  reflectiveness  Float @default(0) // 성찰 깊이
  adaptability    Float @default(0) // 적응적 실행
  collaboration   Float @default(0) // 협력적 실행
  goalClarity     Float @default(0) // 목표 명확성
  emotionalAware  Float @default(0) // 정서 인식력
  growthMindset   Float @default(0) // 성장 마인드셋
  overallScore    Float @default(0) // 종합 점수

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([userId])
}

model DataConsent {
  id            String        @id @default(cuid())
  userId        String
  institutionId String
  coachEmail    String?
  status        ConsentStatus @default(PENDING)

  requestedAt DateTime  @default(now())
  respondedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, institutionId])
  @@index([institutionId])
  @@index([coachEmail])
}

model DirectMessage {
  id         String   @id @default(cuid())
  toUserId   String
  fromName   String   // 보낸 사람 이름 (기관 담당자)
  message    String
  isRead     Boolean  @default(false)

  createdAt  DateTime @default(now())

  toUser User @relation(fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([toUserId, isRead])
}

// ========================================
// 기관/코치 허용 이메일
// ========================================

model AllowedCoach {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
}
